{% extends 'booking/base.html' %}
{% block title %}Team Chat{% endblock %}
{% block content %}

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">

<style>
  *,*::before,*::after { box-sizing:border-box; margin:0; padding:0; }
  :root {
    --bg:#f8fafc; --surface:#fff; --surface2:#f1f5f9; --border:#e2e8f0;
    --accent:#4f46e5; --accent2:#ef4444; --accent3:#10b981;
    --text:#0f172a; --muted:#64748b; --dim:#94a3b8;
    --shadow:0 1px 6px rgba(0,0,0,.06); --shadow-md:0 4px 20px rgba(0,0,0,.08);
    --radius:14px; --radius-sm:8px;
  }
  html,body { font-family:'DM Sans',sans-serif!important; background:var(--bg)!important; color:var(--text)!important; height:100%!important; overflow:hidden!important; }

  /* HEADER */
  .chat-header {
    display:flex; align-items:center; justify-content:space-between;
    padding:0 24px; height:56px; background:var(--surface);
    border-bottom:1.5px solid var(--border); box-shadow:var(--shadow); z-index:10; position:relative;
  }
  .chat-header-left { display:flex; align-items:center; gap:12px; }
  .chat-avatar-group { display:flex; }
  .chat-room-name { font-size:15px; font-weight:700; color:var(--text); }
  .chat-room-sub { font-size:12px; color:var(--muted); }
  .online-dot { width:8px; height:8px; background:#10b981; border-radius:50%; box-shadow:0 0 0 2px #d1fae5; animation:pulse 2s infinite; }
  @keyframes pulse { 0%,100%{box-shadow:0 0 0 2px #d1fae5} 50%{box-shadow:0 0 0 5px rgba(16,185,129,.1)} }
  .back-link { display:inline-flex; align-items:center; gap:6px; font-size:13px; color:var(--muted); text-decoration:none; font-weight:500; padding:6px 12px; border-radius:6px; border:1.5px solid var(--border); transition:.15s; }
  .back-link:hover { color:var(--accent); border-color:var(--accent); }

  /* BODY */
  .chat-body { display:flex; flex-direction:column; height:calc(100vh - 56px); }

  /* MESSAGES */
  .messages-wrap { flex:1; overflow-y:auto; padding:20px 24px; display:flex; flex-direction:column; gap:12px; background:var(--bg); }
  .messages-wrap::-webkit-scrollbar { width:4px; }
  .messages-wrap::-webkit-scrollbar-thumb { background:var(--border); border-radius:4px; }

  /* DATE DIVIDER */
  .date-divider { display:flex; align-items:center; gap:12px; margin:8px 0; }
  .date-divider::before,.date-divider::after { content:''; flex:1; height:1px; background:var(--border); }
  .date-divider span { font-size:11px; color:var(--dim); font-weight:600; text-transform:uppercase; letter-spacing:.8px; white-space:nowrap; }

  /* MESSAGE BUBBLE */
  .msg-row { display:flex; gap:10px; max-width:75%; }
  .msg-row.mine { align-self:flex-end; flex-direction:row-reverse; }
  .msg-avatar { width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:12px; color:white; flex-shrink:0; align-self:flex-end; }
  .msg-content { display:flex; flex-direction:column; gap:3px; }
  .msg-row.mine .msg-content { align-items:flex-end; }
  .msg-sender { font-size:11px; color:var(--dim); font-weight:600; padding:0 4px; }
  .msg-bubble {
    padding:10px 14px; border-radius:16px; font-size:13px; line-height:1.55;
    border:1.5px solid var(--border); background:var(--surface);
    box-shadow:var(--shadow); word-break:break-word;
  }
  .msg-row.mine .msg-bubble { background:var(--accent); color:white; border-color:transparent; border-bottom-right-radius:4px; }
  .msg-row:not(.mine) .msg-bubble { border-bottom-left-radius:4px; }
  .msg-time { font-size:10px; color:var(--dim); padding:0 4px; }
  .msg-row.mine .msg-time { color:rgba(255,255,255,.6); }

  /* Delete button (shows on hover) */
  .msg-row:hover .msg-delete { opacity:1; }
  .msg-delete { opacity:0; background:none; border:none; cursor:pointer; font-size:12px; color:var(--dim); transition:.15s; padding:2px 5px; border-radius:4px; }
  .msg-delete:hover { color:var(--accent2); background:#fef2f2; }

  /* TYPING AREA */
  .chat-input-wrap {
    border-top:1.5px solid var(--border); background:var(--surface);
    padding:14px 24px; display:flex; align-items:flex-end; gap:12px;
    box-shadow:0 -1px 6px rgba(0,0,0,.04);
  }
  .input-box {
    flex:1; background:var(--surface2); border:1.5px solid var(--border);
    border-radius:22px; padding:10px 16px; font-size:13px;
    font-family:'DM Sans',sans-serif; color:var(--text); outline:none;
    resize:none; max-height:120px; line-height:1.5; transition:.2s;
  }
  .input-box:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(79,70,229,.1); background:white; }
  .send-btn {
    width:42px; height:42px; background:var(--accent); color:white;
    border:none; border-radius:50%; cursor:pointer; display:flex;
    align-items:center; justify-content:center; font-size:18px;
    transition:.2s; flex-shrink:0;
  }
  .send-btn:hover { background:#4338ca; transform:scale(1.05); box-shadow:0 4px 16px rgba(79,70,229,.3); }
  .send-btn:disabled { background:var(--border); cursor:default; transform:none; box-shadow:none; }
</style>

<!-- HEADER -->
<header class="chat-header">
  <div class="chat-header-left">
    <div class="online-dot"></div>
    <div>
      <div class="chat-room-name">üí¨ Team Chat</div>
      <div class="chat-room-sub">All staff can see messages</div>
    </div>
  </div>
  <a href="{% url 'dashboard' %}" class="back-link">‚Üê Dashboard</a>
</header>

<div class="chat-body">
  <!-- MESSAGES -->
  <div class="messages-wrap" id="messagesWrap">
    {% for msg in chat_messages %}
    <div class="msg-row {% if msg.sender.username == request.user.username %}mine{% endif %}"
         id="msg-{{ msg.id }}" data-id="{{ msg.id }}">
      {% if msg.sender.username != request.user.username %}
      <div class="msg-avatar" style="background:{{ msg.sender.profile.color|default:'#6366f1' }};">
        {{ msg.sender.username|slice:":1"|upper }}
      </div>
      {% endif %}
      <div class="msg-content">
        {% if msg.sender.username != request.user.username %}
        <div class="msg-sender">{{ msg.sender.username }}</div>
        {% endif %}
        <div class="msg-bubble">{{ msg.message }}</div>
        <div style="display:flex;align-items:center;gap:6px;">
          <span class="msg-time">{{ msg.created_at|date:"g:i A" }}</span>
          {% if msg.sender.username == request.user.username or request.user.is_superuser %}
          <button class="msg-delete" onclick="deleteMsg({{ msg.id }})">üóë</button>
          {% endif %}
        </div>
      </div>
      {% if msg.sender.username == request.user.username %}
      <div class="msg-avatar" style="background:{{ msg.sender.profile.color|default:'#6366f1' }};">
        {{ msg.sender.username|slice:":1"|upper }}
      </div>
      {% endif %}
    </div>
    {% endfor %}
  </div>

  <!-- INPUT -->
  <div class="chat-input-wrap">
    <textarea class="input-box" id="msgInput" placeholder="Type a message‚Ä¶ (Enter to send, Shift+Enter for new line)" rows="1"></textarea>
    <button class="send-btn" id="sendBtn" title="Send">‚û§</button>
  </div>
</div>

<script>
const ME = "{{ request.user.username }}";
const MY_COLOR = "{{ request.user.profile.color|default:'#6366f1' }}";
const IS_SUPER = {{ request.user.is_superuser|yesno:"true,false" }};
const csrftoken = document.cookie.split(';').map(c=>c.trim()).find(c=>c.startsWith('csrftoken='))?.split('=')[1];

const wrap = document.getElementById('messagesWrap');
const input = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');

// Scroll to bottom
function scrollBottom() { wrap.scrollTop = wrap.scrollHeight; }
scrollBottom();

// Auto-resize textarea
input.addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// Send on Enter (Shift+Enter = newline)
input.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});
sendBtn.addEventListener('click', sendMessage);

function buildBubble(m) {
  const mine = m.sender === ME;
  const div = document.createElement('div');
  div.className = `msg-row ${mine ? 'mine' : ''}`;
  div.id = `msg-${m.id}`;
  div.dataset.id = m.id;
  const avatarHtml = `<div class="msg-avatar" style="background:${m.color};">${m.sender.charAt(0).toUpperCase()}</div>`;
  const deleteHtml = (mine || IS_SUPER) ? `<button class="msg-delete" onclick="deleteMsg(${m.id})">üóë</button>` : '';
  div.innerHTML = `
    ${!mine ? avatarHtml : ''}
    <div class="msg-content">
      ${!mine ? `<div class="msg-sender">${m.sender}</div>` : ''}
      <div class="msg-bubble">${escHtml(m.message)}</div>
      <div style="display:flex;align-items:center;gap:6px;">
        <span class="msg-time">${m.created_at}</span>
        ${deleteHtml}
      </div>
    </div>
    ${mine ? avatarHtml : ''}
  `;
  return div;
}

function escHtml(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'); }

async function sendMessage() {
  const text = input.value.trim();
  if (!text) return;
  sendBtn.disabled = true;
  input.value = ''; input.style.height = 'auto';
  try {
    const res = await fetch("{% url 'chat_send' %}", {
      method:'POST',
      headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken},
      body: JSON.stringify({message: text})
    });
    if (res.ok) {
      const m = await res.json();
      wrap.appendChild(buildBubble(m));
      scrollBottom();
    }
  } catch(e) {}
  sendBtn.disabled = false;
  input.focus();
}

async function deleteMsg(id) {
  if (!confirm('Delete this message?')) return;
  try {
    const res = await fetch(`/chat/delete/${id}/`, {
      method:'POST',
      headers:{'X-CSRFToken':csrftoken}
    });
    if (res.ok) {
      const el = document.getElementById(`msg-${id}`);
      if (el) el.remove();
    }
  } catch(e) {}
}

/* POLLING ‚Äî check for new messages every 3 seconds */
let lastId = 0;
document.querySelectorAll('.msg-row').forEach(r => {
  const id = parseInt(r.dataset.id || 0);
  if (id > lastId) lastId = id;
});

async function pollMessages() {
  try {
    const res = await fetch(`/chat/messages/?after=${lastId}`);
    if (!res.ok) return;
    const msgs = await res.json();
    msgs.forEach(m => {
      if (m.is_me) return; // already shown via sendMessage
      const bubble = buildBubble(m);
      wrap.appendChild(bubble);
      if (m.id > lastId) lastId = m.id;
    });
    if (msgs.length) scrollBottom();
  } catch(e) {}
}
setInterval(pollMessages, 3000);
</script>

{% endblock %}
