{% extends 'booking/base.html' %}
{% block title %}Bookings Calendar{% endblock %}
{% load custom_tags %}
{% load static %}
{% block content %}

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">

<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg:#f8fafc; --surface:#fff; --surface2:#f1f5f9; --border:#e2e8f0;
    --accent:#4f46e5; --accent2:#ef4444; --accent3:#10b981;
    --warn:#f59e0b; --text:#0f172a; --muted:#64748b; --dim:#94a3b8;
    --shadow:0 1px 6px rgba(0,0,0,0.06); --shadow-md:0 4px 20px rgba(0,0,0,0.08);
    --radius:14px; --radius-sm:8px;
  }
  html,body { font-family:'DM Sans',sans-serif!important; background:var(--bg)!important; color:var(--text)!important; height:100%!important; overflow:hidden!important; }

  /* HEADER */
  .app-header { display:flex; align-items:center; justify-content:space-between; padding:0 24px; height:56px; background:var(--surface); border-bottom:1.5px solid var(--border); position:relative; z-index:10; box-shadow:var(--shadow); }
  .header-brand { display:flex; align-items:center; gap:10px; font-weight:700; font-size:15px; color:var(--text); }
  .header-brand .dot { width:8px; height:8px; background:var(--accent); border-radius:50%; box-shadow:0 0 0 3px rgba(79,70,229,.2); animation:pulse 2.5s ease-in-out infinite; }
  @keyframes pulse { 0%,100%{box-shadow:0 0 0 3px rgba(79,70,229,.2)} 50%{box-shadow:0 0 0 6px rgba(79,70,229,.06)} }
  .header-right { display:flex; align-items:center; gap:14px; }
  .header-user { display:flex; align-items:center; gap:8px; font-size:13px; color:var(--muted); }
  .avatar { width:30px; height:30px; background:linear-gradient(135deg,var(--accent),#818cf8); border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:12px; color:white; }
  .btn-logout { font-size:12px; padding:5px 12px; border-radius:6px; background:var(--surface2); color:var(--muted); text-decoration:none; border:1.5px solid var(--border); transition:.2s; font-weight:500; }
  .btn-logout:hover { color:var(--accent); border-color:var(--accent); }

  /* LAYOUT */
  .app-body { display:flex; height:calc(100vh - 56px); overflow:hidden; }

  /* SIDEBAR */
  .sidebar { width:230px; background:var(--surface); border-right:1.5px solid var(--border); padding:18px 14px; display:flex; flex-direction:column; gap:16px; overflow-y:auto; flex-shrink:0; box-shadow:var(--shadow); }
  .clock-widget { background:linear-gradient(135deg,var(--accent),#6366f1); border-radius:var(--radius); padding:16px; text-align:center; box-shadow:0 4px 16px rgba(79,70,229,.2); }
  .clock-time { font-family:'DM Mono',monospace; font-size:24px; font-weight:500; color:white; letter-spacing:1px; }
  .clock-date { font-size:11px; color:rgba(255,255,255,.8); margin-top:4px; }
  .sidebar-label { font-size:10px; text-transform:uppercase; letter-spacing:1.5px; color:var(--dim); padding:0 8px; margin-bottom:4px; }
  .nav-item { display:flex; align-items:center; gap:10px; padding:9px 12px; border-radius:var(--radius-sm); font-size:13px; color:var(--muted); text-decoration:none; transition:.15s; border:1.5px solid transparent; font-weight:500; }
  .nav-item:hover,.nav-item.active { background:var(--surface2); color:var(--text); border-color:var(--border); }
  .nav-item.active { color:var(--accent); background:#eef2ff; border-color:#c7d2fe; }

  /* üÜï TODO WIDGET */
  .todo-widget { display:flex; flex-direction:column; gap:5px; }
  .todo-item { display:flex; align-items:center; gap:8px; padding:7px 10px; border-radius:var(--radius-sm); background:var(--surface2); border:1.5px solid var(--border); font-size:12px; transition:.15s; cursor:pointer; text-decoration:none; }
  .todo-item:hover { border-color:var(--accent); background:#eef2ff; }
  .todo-check { width:14px; height:14px; border-radius:3px; border:2px solid var(--border); background:white; flex-shrink:0; }
  .todo-check.done { background:var(--accent3); border-color:var(--accent3); }
  .todo-title { flex:1; color:var(--text); font-weight:500; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .todo-prio { font-size:9px; font-weight:700; padding:2px 5px; border-radius:8px; text-transform:uppercase; }
  .todo-prio.High   { background:#fee2e2; color:#dc2626; }
  .todo-prio.Medium { background:#fef9c3; color:#b45309; }
  .todo-prio.Low    { background:#d1fae5; color:#059669; }

  .trip-item { background:var(--surface2); border:1.5px solid var(--border); border-radius:var(--radius-sm); padding:10px 12px; font-size:12px; }
  .trip-dest { font-weight:600; color:var(--text); margin-bottom:2px; }
  .trip-date { color:var(--muted); }
  .trip-notes { color:var(--dim); margin-top:2px; font-style:italic; }

  /* MAIN */
  .main-content { flex:1; display:flex; flex-direction:column; overflow:hidden; }
  .main-scroll { flex:1; overflow-y:auto; padding:22px; display:flex; flex-direction:column; gap:20px; }
  .main-scroll::-webkit-scrollbar { width:4px; }
  .main-scroll::-webkit-scrollbar-thumb { background:var(--border); border-radius:4px; }
  .page-title { font-size:20px; font-weight:700; color:var(--text); letter-spacing:-.4px; }
  .page-sub { font-size:13px; color:var(--muted); margin-top:3px; }
  .badge { display:inline-flex; align-items:center; gap:4px; padding:2px 9px; border-radius:20px; font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:.6px; }
  .badge.live { background:#d1fae5; color:#059669; border:1.5px solid #a7f3d0; }

  /* GRID */
  .content-grid { display:grid; grid-template-columns:1fr 300px; gap:20px; }
  .left-col,.right-col { display:flex; flex-direction:column; gap:20px; }

  /* CARD */
  .card { background:var(--surface); border:1.5px solid var(--border); border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow); }
  .card-header { padding:12px 18px; border-bottom:1.5px solid var(--border); font-size:13px; font-weight:600; color:var(--muted); display:flex; align-items:center; gap:8px; background:var(--surface2); }
  .card-body { padding:16px 18px; }

  /* FULLCALENDAR */
  .fc { --fc-border-color:var(--border); --fc-today-bg-color:#eef2ff; --fc-event-border-color:transparent; font-family:'DM Sans',sans-serif; font-size:12px; color:var(--text); }
  .fc th { color:var(--muted); font-weight:600; background:var(--surface2); }
  .fc .fc-daygrid-day-number { color:var(--muted); font-size:12px; }
  .fc .fc-daygrid-day.fc-day-today .fc-daygrid-day-number { color:var(--accent); font-weight:700; }
  .fc .fc-toolbar-title { font-size:14px; font-weight:700; color:var(--text); }
  .fc .fc-button { font-size:11px!important; padding:5px 10px!important; border-radius:6px!important; border:1.5px solid var(--border)!important; color:var(--muted)!important; background:var(--surface2)!important; transition:.15s!important; }
  .fc .fc-button:hover { color:var(--accent)!important; border-color:var(--accent)!important; background:white!important; }
  .fc .fc-button-primary:not(:disabled).fc-button-active { background:var(--accent)!important; color:white!important; border-color:var(--accent)!important; }
  .fc .fc-daygrid-event { border-radius:4px; font-size:10px; padding:2px 6px; }

  /* TIMELINE */
  .timeline-wrap { overflow-x:auto; }
  .timeline-table { width:100%; border-collapse:collapse; font-size:11px; font-family:'DM Mono',monospace; min-width:900px; }
  .timeline-table th,.timeline-table td { border:1px solid var(--border); padding:5px 4px; text-align:center; color:var(--muted); }
  .timeline-table th { background:var(--surface2); font-weight:600; font-size:10px; }
  .timeline-table td.room-name { background:var(--surface2); font-family:'DM Sans',sans-serif; font-weight:600; font-size:11px; color:var(--text); text-align:left; padding:6px 10px; white-space:nowrap; min-width:100px; }
  .timeline-booking { position:absolute; top:5px; height:28px; min-width:30px; border-radius:6px; cursor:pointer; overflow:hidden; display:flex; align-items:center; gap:5px; padding:0 8px; transition:transform .15s,box-shadow .15s; z-index:2; }
  .timeline-booking:hover { transform:scaleY(1.1); box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:3; }
  .t-title { font-size:10px; font-weight:600; color:white; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .t-time  { font-size:9px; color:rgba(255,255,255,.8); font-family:'DM Mono',monospace; white-space:nowrap; }

  /* ACTIONS */
  .action-btn { display:flex; align-items:center; gap:10px; padding:11px 14px; border-radius:var(--radius-sm); font-size:13px; font-weight:600; text-decoration:none; transition:.2s; border:1.5px solid var(--border); }
  .action-btn.primary { background:var(--accent); color:white; border-color:var(--accent); }
  .action-btn.primary:hover { background:#4338ca; box-shadow:0 4px 16px rgba(79,70,229,.25); }
  .action-btn.secondary { background:var(--surface2); color:var(--muted); }
  .action-btn.secondary:hover { color:var(--text); border-color:#cbd5e1; background:white; }
  .action-btn.teal { background:linear-gradient(135deg,#10b981,#059669); color:white; border-color:transparent; }
  .action-btn.teal:hover { opacity:.9; box-shadow:0 4px 16px rgba(16,185,129,.3); }
  .action-btn.amber { background:linear-gradient(135deg,#f59e0b,#d97706); color:white; border-color:transparent; }
  .action-btn.amber:hover { opacity:.9; box-shadow:0 4px 16px rgba(245,158,11,.3); }
  .action-btn.violet { background:linear-gradient(135deg,#8b5cf6,#7c3aed); color:white; border-color:transparent; }
  .action-btn.violet:hover { opacity:.9; box-shadow:0 4px 16px rgba(139,92,246,.3); }

  /* MODALS */
  .modal-overlay { display:none; position:fixed; inset:0; background:rgba(15,23,42,0.4); backdrop-filter:blur(4px); z-index:200; align-items:center; justify-content:center; }
  .modal-overlay.open { display:flex; }
  .modal-box { background:var(--surface); border:1.5px solid var(--border); border-radius:18px; width:90%; max-width:900px; max-height:85vh; display:flex; overflow:hidden; position:relative; box-shadow:0 20px 60px rgba(0,0,0,0.15); animation:modalIn .2s ease; }
  @keyframes modalIn { from{opacity:0;transform:scale(.96) translateY(8px)} to{opacity:1;transform:scale(1) translateY(0)} }
  .modal-close { position:absolute; top:14px; right:14px; width:28px; height:28px; background:var(--surface2); border:1.5px solid var(--border); border-radius:6px; cursor:pointer; color:var(--muted); font-size:14px; display:flex; align-items:center; justify-content:center; transition:.15s; z-index:10; }
  .modal-close:hover { color:var(--accent2); border-color:var(--accent2); }
  .modal-rooms { width:270px; border-right:1.5px solid var(--border); overflow-y:auto; padding:18px 12px; background:var(--surface2); display:flex; flex-direction:column; gap:8px; flex-shrink:0; }
  .modal-rooms-title { font-size:11px; text-transform:uppercase; letter-spacing:1.2px; color:var(--dim); padding:0 4px; margin-bottom:4px; font-weight:600; }
  .room-card { cursor:pointer; border-radius:var(--radius-sm); border:1.5px solid var(--border); overflow:hidden; transition:.15s; background:var(--surface); }
  .room-card:hover { border-color:var(--accent); box-shadow:0 2px 12px rgba(79,70,229,.1); }
  .room-card.selected { border-color:var(--accent); box-shadow:0 0 0 3px rgba(79,70,229,.15); }
  .room-card img { width:100%; height:80px; object-fit:cover; display:block; }
  .room-card-name { padding:7px 10px 2px; font-size:12px; font-weight:600; color:var(--text); }
  .room-card-price { padding:0 10px 7px; font-size:11px; color:var(--accent3); font-weight:700; }
  .modal-detail { flex:1; padding:24px; overflow-y:auto; display:flex; flex-direction:column; gap:16px; }
  .detail-img { width:100%; height:180px; object-fit:cover; border-radius:var(--radius-sm); background:var(--surface2); }
  .detail-name { font-size:18px; font-weight:700; color:var(--text); }
  .detail-specs { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .spec-item { background:var(--surface2); border:1.5px solid var(--border); border-radius:var(--radius-sm); padding:10px 12px; font-size:12px; }
  .spec-label { color:var(--dim); font-size:10px; text-transform:uppercase; letter-spacing:.8px; margin-bottom:3px; font-weight:600; }
  .spec-val { color:var(--text); font-weight:600; }
  .btn-book { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:11px 22px; background:var(--accent); color:white; border:none; border-radius:var(--radius-sm); font-size:14px; font-weight:600; cursor:pointer; transition:.2s; align-self:flex-start; font-family:'DM Sans',sans-serif; }
  .btn-book:hover { background:#4338ca; box-shadow:0 4px 16px rgba(79,70,229,.25); }

  /* DETAILS MODAL */
  .details-modal { display:none; position:fixed; inset:0; background:rgba(15,23,42,0.4); backdrop-filter:blur(4px); z-index:300; align-items:center; justify-content:center; }
  .details-modal.open { display:flex; }
  .details-box { background:var(--surface); border:1.5px solid var(--border); border-radius:18px; width:90%; max-width:450px; padding:24px; position:relative; box-shadow:0 20px 60px rgba(0,0,0,0.15); animation:modalIn .2s ease; }
  .details-box img { width:100%; height:160px; object-fit:cover; border-radius:var(--radius-sm); margin-bottom:16px; }
  .details-title { font-size:17px; font-weight:700; margin-bottom:14px; color:var(--text); }
  .detail-row { display:flex; justify-content:space-between; padding:9px 0; border-bottom:1.5px solid var(--border); font-size:13px; }
  .detail-row:last-of-type { border-bottom:none; }
  .detail-row .label { color:var(--muted); }
  .detail-row .val { font-weight:600; color:var(--text); }
  .btn-cancel-booking { display:flex; align-items:center; justify-content:center; margin-top:16px; padding:10px; border-radius:var(--radius-sm); background:#fef2f2; border:1.5px solid #fecaca; color:var(--accent2); font-size:13px; font-weight:600; cursor:pointer; transition:.2s; font-family:'DM Sans',sans-serif; width:100%; }
  .btn-cancel-booking:hover { background:#fee2e2; }

  /* üÜï FLOATING CHAT BUTTON */
  .float-chat { position:fixed; bottom:28px; right:28px; z-index:500; width:52px; height:52px; background:linear-gradient(135deg,#10b981,#059669); border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 20px rgba(16,185,129,.4); cursor:pointer; text-decoration:none; transition:.25s; font-size:22px; }
  .float-chat:hover { transform:scale(1.1) rotate(-10deg); box-shadow:0 8px 28px rgba(16,185,129,.5); }

  *::-webkit-scrollbar { width:4px; height:4px; }
  *::-webkit-scrollbar-thumb { background:var(--border); border-radius:4px; }
</style>

<!-- HEADER -->
<header class="app-header">
  <div class="header-brand"><div class="dot"></div> Training Rooms</div>
  <div class="header-right">
    <div class="header-user">
      <div class="avatar">{{ request.user.username|slice:":1"|upper }}</div>
      <span>{{ request.user.username }}</span>
    </div>
    <a href="{% url 'logout' %}" class="btn-logout">Sign out</a>
  </div>
</header>

<div class="app-body">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="clock-widget">
      <div class="clock-time" id="clock">00:00:00</div>
      <div class="clock-date" id="date">Loading‚Ä¶</div>
    </div>

    <div>
      <div class="sidebar-label">Navigation</div>
      <a class="nav-item active" href="#">üìÖ Bookings</a>
      <a class="nav-item" href="{% url 'trip_create' %}">‚úàÔ∏è Compartment</a>
      <a class="nav-item" href="{% url 'todo_list' %}">‚úÖ My Tasks</a>
      <a class="nav-item" href="{% url 'chat_view' %}">üí¨ Team Chat</a>
      <a class="nav-item" href="{% url 'project_list' %}">üóÇ Projects</a>
    </div>

    <!-- üÜï TODO PREVIEW -->
    {% if todos %}
    <div>
      <div class="sidebar-label">Pending Tasks</div>
      <div class="todo-widget">
        {% for todo in todos %}
        <a class="todo-item" href="{% url 'todo_list' %}">
          <div class="todo-check {% if todo.is_done %}done{% endif %}"></div>
          <div class="todo-title">{{ todo.title }}</div>
          <span class="todo-prio {{ todo.priority }}">{{ todo.priority }}</span>
        </a>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    {% if trips %}
    <div>
      <div class="sidebar-label">Upcoming Trips</div>
      {% for t in trips %}
      <div class="trip-item">
        <div class="trip-dest">{{ t.destination }}</div>
        <div class="trip-date">{{ t.date }}</div>
        {% if t.notes %}<div class="trip-notes">{{ t.notes }}</div>{% endif %}
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </aside>

  <!-- MAIN -->
  <div class="main-content">
    <div class="main-scroll">
      <div>
        <div class="page-title">Bookings Calendar</div>
        <div class="page-sub">{{ selected_date }} &nbsp;¬∑&nbsp; <span class="badge live">‚óè Live</span></div>
      </div>

      <div class="content-grid">
        <!-- LEFT -->
        <div class="left-col">
          <div class="card">
            <div class="card-header">üìÖ Monthly Overview</div>
            <div class="card-body" style="padding:12px;"><div id="fc-calendar"></div></div>
          </div>
          <div class="card">
            <div class="card-header">‚è± Hourly Timeline ‚Äî {{ selected_date }}</div>
            <div class="card-body" style="padding:0 0 12px 0;">
              <div class="timeline-wrap" style="padding:0 12px;">
                <table class="timeline-table">
                  <thead>
                    <tr>
                      <th>Room</th>
                      {% for h in 0|to:23 %}<th>{{ h|stringformat:"02d" }}</th>{% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for rb in room_bookings %}
                    <tr style="height:38px; position:relative;">
                      <td class="room-name">{{ rb.room.name }}</td>
                      <td colspan="24" style="position:relative; padding:0; height:38px;">
                        {% for b in rb.bookings %}
                        {% with sh=b.start.hour sm=b.start.minute eh=b.end.hour em=b.end.minute %}
                        <div class="timeline-booking"
                             style="left:calc({{ sh|default:0 }}*60/1440*100% + {{ sm|default:0 }}/1440*100%);
                                    width:calc(({{ eh|default:0 }}*60+{{ em|default:0 }}-{{ sh|default:0 }}*60-{{ sm|default:0 }})/1440*100%);
                                    background:linear-gradient(90deg,{{ b.created_by.profile.color|default:'#4f46e5' }},{{ b.created_by.profile.color|default:'#4338ca' }}cc);"
                             data-booking-id="{{ b.id }}"
                             data-room-name="{{ b.room.name }}"
                             data-created-by="{{ b.created_by.username }}"
                             data-attendees="{{ b.attendees }}"
                             data-room-image="{% if b.room.image %}{{ b.room.image.url }}{% else %}{% static 'img/placeholder.png' %}{% endif %}"
                             data-start="{{ b.start }}"
                             data-end="{{ b.end }}"
                             data-title="{{ b.title }}"
                             data-cost="{{ b.total_cost }}"
                             onclick="openBookingDetails(this)">
                          <div class="t-title">{{ b.title }}</div>
                          <div class="t-time">{{ b.start|date:"H:i" }}-{{ b.end|date:"H:i" }}</div>
                        </div>
                        {% endwith %}
                        {% endfor %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="right-col">
          <div class="card">
            <div class="card-header">‚ö° Quick Actions</div>
            <div class="card-body" style="display:flex;flex-direction:column;gap:8px;">
              <a href="#" id="openNewBooking" class="action-btn primary">Ôºã New Booking</a>
              <a href="{% url 'trip_create' %}" class="action-btn secondary">‚úàÔ∏è Add Trip</a>
              <a href="{% url 'todo_list' %}" class="action-btn amber">‚úÖ My Tasks</a>
              <a href="{% url 'chat_view' %}" class="action-btn teal">üí¨ Team Chat</a>
              <a href="{% url 'project_list' %}" class="action-btn violet">üóÇ Projects</a>
            </div>
          </div>
          <div class="card" style="flex:1;">
            <div class="card-header">üìç Upcoming Trips</div>
            <div class="card-body" style="display:flex;flex-direction:column;gap:8px;">
              {% for t in trips %}
              <div class="trip-item">
                <div class="trip-dest">{{ t.destination }}</div>
                <div class="trip-date">{{ t.date }}</div>
                {% if t.notes %}<div class="trip-notes">{{ t.notes }}</div>{% endif %}
              </div>
              {% empty %}
              <div style="color:var(--dim);font-size:12px;text-align:center;padding:16px 0;">No upcoming trips.</div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- üÜï FLOATING CHAT BUTTON -->
<a href="{% url 'chat_view' %}" class="float-chat" title="Team Chat">üí¨</a>

<!-- BOOKING FORM MODAL -->
<div class="modal-overlay" id="bookingFormModal">
  <div class="modal-box">
    <button class="modal-close" id="closeBookingFormModal">‚úï</button>
    <div class="modal-rooms">
      <div class="modal-rooms-title">Select Room</div>
      {% for room in rooms %}
      <div class="room-card"
           data-room-id="{{ room.id }}"
           data-room-name="{{ room.name }}"
           data-capacity="{{ room.capacity }}"
           data-projector="{{ room.projector }}"
           data-speaker="{{ room.speaker }}"
           data-tables="{{ room.tables }}"
           data-chairs="{{ room.chairs }}"
           data-price="{{ room.price_per_hour }}"
           data-image="{% if room.image %}{{ room.image.url }}{% else %}{% static 'img/placeholder.png' %}{% endif %}">
        <img src="{% if room.image %}{{ room.image.url }}{% else %}{% static 'img/placeholder.png' %}{% endif %}" alt="{{ room.name }}">
        <div class="room-card-name">{{ room.name }}</div>
        {% if room.price_per_hour > 0 %}<div class="room-card-price">‚Ç±{{ room.price_per_hour }}/hr</div>{% endif %}
      </div>
      {% endfor %}
    </div>
    <div class="modal-detail">
      <img class="detail-img" id="detailImage" src="{% static 'img/placeholder.png' %}" alt="">
      <div class="detail-name" id="detailRoomNameModal">Select a room to see details</div>
      <div class="detail-specs">
        <div class="spec-item"><div class="spec-label">Capacity</div><div class="spec-val" id="detailCapacity">‚Äî</div></div>
        <div class="spec-item"><div class="spec-label">Projector</div><div class="spec-val" id="detailProjector">‚Äî</div></div>
        <div class="spec-item"><div class="spec-label">Speaker</div><div class="spec-val" id="detailSpeaker">‚Äî</div></div>
        <div class="spec-item"><div class="spec-label">Tables</div><div class="spec-val" id="detailTables">‚Äî</div></div>
        <div class="spec-item"><div class="spec-label">Chairs</div><div class="spec-val" id="detailChairs">‚Äî</div></div>
        <div class="spec-item"><div class="spec-label">Rate / hr</div><div class="spec-val" id="detailPrice">‚Äî</div></div>
      </div>
      <button class="btn-book" id="bookRoomBtn" style="display:none;">Book This Room ‚Üí</button>
    </div>
  </div>
</div>

<!-- DETAILS MODAL -->
<div class="details-modal" id="bookingDetailsModal">
  <div class="details-box">
    <button class="modal-close" id="closeBookingDetailsModal">‚úï</button>
    <img id="detailRoomImage" src="" alt="">
    <div class="details-title" id="detailTitle">Booking Details</div>
    <div class="detail-row"><span class="label">Room</span><span class="val" id="detailRoomName">‚Äî</span></div>
    <div class="detail-row"><span class="label">Booked By</span><span class="val" id="detailBookedBy">‚Äî</span></div>
    <div class="detail-row"><span class="label">Attendees</span><span class="val" id="detailAttendees">‚Äî</span></div>
    <div class="detail-row"><span class="label">Date</span><span class="val" id="detailDate">‚Äî</span></div>
    <div class="detail-row"><span class="label">Time</span><span class="val" id="detailTime">‚Äî</span></div>
    <div class="detail-row"><span class="label">Total Cost</span><span class="val" id="detailCost" style="color:var(--accent3);">‚Äî</span></div>
    <button class="btn-cancel-booking" id="cancelBookingBtn">Cancel Booking</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  /* CLOCK */
  function updateClock() {
    const now = new Date();
    document.getElementById('clock').textContent = now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
    document.getElementById('date').textContent = now.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'});
  }
  setInterval(updateClock, 1000); updateClock();

  /* CSRF */
  const csrftoken = document.cookie.split(';').map(c=>c.trim()).find(c=>c.startsWith('csrftoken='))?.split('=')[1];

  /* FULLCALENDAR */
  const calendar = new FullCalendar.Calendar(document.getElementById('fc-calendar'), {
    initialView:'dayGridMonth', height:420,
    headerToolbar:{left:'prev,next today',center:'title',right:'dayGridMonth,timeGridWeek,listWeek'},
    events:"{% url 'api_bookings' %}",
    eventClick: function(info) {
      const e = info.event.extendedProps;
      document.getElementById('detailTitle').textContent = info.event.title;
      document.getElementById('detailRoomImage').src = e.room_image || "{% static 'img/placeholder.png' %}";
      document.getElementById('detailRoomName').textContent = e.room_name || '‚Äî';
      document.getElementById('detailBookedBy').textContent = e.created_by || '‚Äî';
      document.getElementById('detailAttendees').textContent = e.attendees || '‚Äî';
      document.getElementById('detailDate').textContent = new Date(info.event.start).toLocaleDateString();
      document.getElementById('detailTime').textContent =
        info.event.start.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) + ' ‚Äì ' +
        info.event.end.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
      const cost = e.total_cost;
      document.getElementById('detailCost').textContent = cost > 0 ? '‚Ç±' + parseFloat(cost).toFixed(2) : 'Free';
      document.getElementById('cancelBookingBtn').dataset.bookingId = info.event.id;
      document.getElementById('bookingDetailsModal').classList.add('open');
    }
  });
  calendar.render();

  /* TIMELINE CLICK */
  window.openBookingDetails = function(el) {
    document.getElementById('detailTitle').textContent = el.dataset.title || 'Booking';
    document.getElementById('detailRoomImage').src = el.dataset.roomImage;
    document.getElementById('detailRoomName').textContent = el.dataset.roomName;
    document.getElementById('detailBookedBy').textContent = el.dataset.createdBy;
    document.getElementById('detailAttendees').textContent = el.dataset.attendees;
    const start = new Date(el.dataset.start), end = new Date(el.dataset.end);
    document.getElementById('detailDate').textContent = start.toLocaleDateString();
    document.getElementById('detailTime').textContent =
      start.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) + ' ‚Äì ' +
      end.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    const cost = parseFloat(el.dataset.cost || 0);
    document.getElementById('detailCost').textContent = cost > 0 ? '‚Ç±' + cost.toFixed(2) : 'Free';
    document.getElementById('cancelBookingBtn').dataset.bookingId = el.dataset.bookingId;
    document.getElementById('bookingDetailsModal').classList.add('open');
  };

  /* BOOKING MODAL */
  const bookingModal = document.getElementById('bookingFormModal');
  document.getElementById('openNewBooking').addEventListener('click', e => { e.preventDefault(); bookingModal.classList.add('open'); });
  document.getElementById('closeBookingFormModal').addEventListener('click', () => bookingModal.classList.remove('open'));
  bookingModal.addEventListener('click', e => { if(e.target===bookingModal) bookingModal.classList.remove('open'); });

  bookingModal.querySelectorAll('.room-card').forEach(card => {
    card.addEventListener('click', () => {
      bookingModal.querySelectorAll('.room-card').forEach(c=>c.classList.remove('selected'));
      card.classList.add('selected');
      document.getElementById('detailImage').src = card.dataset.image;
      document.getElementById('detailRoomNameModal').textContent = card.dataset.roomName;
      document.getElementById('detailCapacity').textContent = card.dataset.capacity;
      document.getElementById('detailProjector').textContent = card.dataset.projector;
      document.getElementById('detailSpeaker').textContent = card.dataset.speaker;
      document.getElementById('detailTables').textContent = card.dataset.tables;
      document.getElementById('detailChairs').textContent = card.dataset.chairs;
      const price = parseFloat(card.dataset.price || 0);
      document.getElementById('detailPrice').textContent = price > 0 ? '‚Ç±' + price.toFixed(2) + '/hr' : 'Free';
      const btn = document.getElementById('bookRoomBtn');
      btn.style.display = 'inline-flex';
      btn.onclick = () => window.location.href = `/bookings/new/?room_id=${card.dataset.roomId}`;
    });
  });

  /* DETAILS MODAL */
  const detailsModal = document.getElementById('bookingDetailsModal');
  document.getElementById('closeBookingDetailsModal').addEventListener('click', () => detailsModal.classList.remove('open'));
  detailsModal.addEventListener('click', e => { if(e.target===detailsModal) detailsModal.classList.remove('open'); });

  /* CANCEL */
  document.getElementById('cancelBookingBtn').addEventListener('click', function() {
    const id = this.dataset.bookingId; if (!id) return;
    if (!confirm('Cancel this booking?')) return;
    fetch(`/cancel-booking/${id}/`, {method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken},body:JSON.stringify({})})
      .then(res => {
        if (res.ok) {
          const ev = calendar.getEventById(id); if(ev) ev.remove();
          const tb = document.querySelector(`.timeline-booking[data-booking-id='${id}']`); if(tb) tb.remove();
          detailsModal.classList.remove('open');
        } else alert('Failed to cancel booking.');
      });
  });
});
</script>
{% endblock %}
