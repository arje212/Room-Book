{% extends "booking/base.html" %}
{% block content %}

<div class="flex flex-col lg:flex-row min-h-screen bg-gray-50 font-sans text-gray-800">
  <main class="flex-1 px-6 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-3xl font-bold text-sky-700 flex items-center gap-2">
        <i class="bi bi-speedometer2 text-sky-400 text-2xl"></i> Admin Dashboard
      </h1>
      <a href="{% url 'logout' %}" class="inline-flex items-center px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition">
        <i class="bi bi-box-arrow-right me-2"></i> Logout
      </a>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
      {% for card in summary_cards %}
      <div class="relative bg-white rounded-lg shadow p-6 overflow-hidden">
        <div class="absolute card-bubble bubble-lg bg-sky-300"></div>
        <div class="absolute card-bubble bubble-md bg-sky-400"></div>
        <div class="flex flex-col items-center text-center">
          <i class="bi {{ card.icon }} text-3xl text-sky-500 mb-2"></i>
          <h6 class="text-sm font-semibold text-gray-500 uppercase">{{ card.label }}</h6>
          <h2 class="text-3xl font-bold text-gray-900">{{ card.count }}</h2>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Booking History Table -->
    <section class="mb-12">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-sky-600 flex items-center gap-2">
          <i class="bi bi-calendar-week text-sky-400"></i> Booking History
        </h2>
        <a href="{% url 'export_bookings' %}" class="inline-flex items-center px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition">
          <i class="bi bi-file-earmark-excel me-2"></i> Export to Excel
        </a>
      </div>

      <div class="overflow-x-auto bg-white rounded-lg shadow">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-sky-100 text-sky-700 text-sm uppercase tracking-wider">
            <tr>
              <th class="px-6 py-3 text-left">ID</th>
              <th class="px-6 py-3 text-left">User</th>
              <th class="px-6 py-3 text-left">Room</th>
              <th class="px-6 py-3 text-left">Start</th>
              <th class="px-6 py-3 text-left">End</th>
              <th class="px-6 py-3 text-left">Status</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-100 text-sm text-gray-700">
            {% for booking in bookings %}
            <tr>
              <td class="px-6 py-4">{{ booking.id }}</td>
              <td class="px-6 py-4">{{ booking.created_by.username }}</td>
              <td class="px-6 py-4">{{ booking.room.name }}</td>
              <td class="px-6 py-4">{{ booking.start|date:"M d, Y H:i" }}</td>
              <td class="px-6 py-4">{{ booking.end|date:"M d, Y H:i" }}</td>
              <td class="px-6 py-4">
                <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold
                  {% if booking.status == 'Approved' %} bg-green-100 text-green-700
                  {% elif booking.status == 'Pending' %} bg-yellow-100 text-yellow-800
                  {% elif booking.status == 'Rejected' %} bg-red-100 text-red-700
                  {% else %} bg-gray-200 text-gray-600 {% endif %}">
                  {{ booking.status }}
                </span>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="px-6 py-4 text-center text-gray-400">No bookings found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- Staff Accounts Table -->
    <section>
      <h2 class="text-xl font-bold text-sky-600 mb-4 flex items-center gap-2">
        <i class="bi bi-people-fill text-sky-400"></i> Staff Accounts
      </h2>
      <div class="overflow-x-auto bg-white rounded-lg shadow">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-sky-100 text-sky-700 text-sm uppercase tracking-wider">
            <tr>
              <th class="px-6 py-3 text-left">ID</th>
              <th class="px-6 py-3 text-left">Username</th>
              <th class="px-6 py-3 text-left">Email</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-100 text-sm text-gray-700">
            {% for staff in staff_accounts %}
            <tr>
              <td class="px-6 py-4">{{ staff.id }}</td>
              <td class="px-6 py-4">{{ staff.username }}</td>
              <td class="px-6 py-4">{{ staff.email }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="3" class="px-6 py-4 text-center text-gray-400">No staff accounts found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- Password Change Requests Table -->
    <section class="mt-12">
      <h2 class="text-xl font-bold text-sky-600 mb-4 flex items-center gap-2">
        <i class="bi bi-key-fill text-sky-400"></i> Password Change Requests
      </h2>
      <div class="overflow-x-auto bg-white rounded-lg shadow">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-sky-100 text-sky-700 text-sm uppercase tracking-wider">
            <tr>
              <th class="px-6 py-3 text-left">User</th>
              <th class="px-6 py-3 text-left">Requested At</th>
              <th class="px-6 py-3 text-left">Status</th>
              <th class="px-6 py-3 text-left">Action</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-100 text-sm text-gray-700">
            {% for req in password_requests %}
            <tr>
              <td class="px-6 py-4 font-medium">{{ req.user.username }}</td>
              <td class="px-6 py-4">{{ req.requested_at|date:"M d, Y H:i" }}</td>
              <td class="px-6 py-4">
                <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800">
                  Pending
                </span>
              </td>
              <td class="px-6 py-4 space-x-2">
                <a href="{% url 'approve_password_change' req.id %}" class="inline-block px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 transition text-xs font-semibold">Approve</a>
                <a href="{% url 'reject_password_change' req.id %}" class="inline-block px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition text-xs font-semibold">Reject</a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4" class="px-6 py-4 text-center text-gray-400">No pending password requests.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- Pending User Registrations Table -->
    <section class="mt-12">
      <h2 class="text-xl font-bold text-sky-600 mb-4 flex items-center gap-2">
        <i class="bi bi-person-plus-fill text-sky-400"></i> Pending User Registrations
      </h2>
      <div class="overflow-x-auto bg-white rounded-lg shadow">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-sky-100 text-sky-700 text-sm uppercase tracking-wider">
            <tr>
              <th class="px-6 py-3 text-left">ID</th>
              <th class="px-6 py-3 text-left">Username</th>
              <th class="px-6 py-3 text-left">Email</th>
              <th class="px-6 py-3 text-left">Date Joined</th>
              <th class="px-6 py-3 text-left">Action</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-100 text-sm text-gray-700">
            {% for user in pending_users %}
            <tr>
              <td class="px-6 py-4">{{ user.id }}</td>
              <td class="px-6 py-4 font-medium">{{ user.username }}</td>
              <td class="px-6 py-4">{{ user.email }}</td>
              <td class="px-6 py-4">{{ user.date_joined|date:"M d, Y H:i" }}</td>
              <td class="px-6 py-4 space-x-2">
                <a href="{% url 'approve_user' user.id %}" class="inline-block px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 transition text-xs font-semibold">Approve</a>
                <a href="{% url 'reject_user' user.id %}" class="inline-block px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition text-xs font-semibold">Reject</a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="px-6 py-4 text-center text-gray-400">No pending registrations.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- Room Management Section -->
    <section class="mt-12">
      <h2 class="text-xl font-bold text-sky-600 mb-4 flex items-center gap-2">
        <i class="bi bi-door-open-fill text-sky-400"></i> Room Management
      </h2>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for room in rooms %}
        <div class="bg-white rounded-lg shadow p-6 flex flex-col gap-4">
          {% if room.image %}
            <img src="{{ room.image.url }}" alt="{{ room.name }}" class="w-full h-40 object-cover rounded">
          {% else %}
            <img src="https://via.placeholder.com/300x150?text=Room" alt="{{ room.name }}" class="w-full h-40 object-cover rounded">
          {% endif %}

          <form method="POST" action="{% url 'update_room' room.id %}" enctype="multipart/form-data" class="flex flex-col gap-3">
            {% csrf_token %}
            <label class="text-sm font-semibold text-gray-700">Room Name</label>
            <input type="text" name="name" value="{{ room.name }}" class="border border-gray-300 rounded px-3 py-2 text-sm">

            <label class="text-sm font-semibold text-gray-700">Capacity</label>
            <input type="number" name="capacity" value="{{ room.capacity }}" class="border border-gray-300 rounded px-3 py-2 text-sm">

            <label class="text-sm font-semibold text-gray-700">Projector</label>
            <select name="projector" class="border border-gray-300 rounded px-3 py-2 text-sm">
              <option value="Yes" {% if room.projector == "Yes" %}selected{% endif %}>Yes</option>
              <option value="No" {% if room.projector == "No" %}selected{% endif %}>No</option>
            </select>

            <label class="text-sm font-semibold text-gray-700">Speaker</label>
            <select name="speaker" class="border border-gray-300 rounded px-3 py-2 text-sm">
              <option value="Yes" {% if room.speaker == "Yes" %}selected{% endif %}>Yes</option>
              <option value="No" {% if room.speaker == "No" %}selected{% endif %}>No</option>
            </select>

            <label class="text-sm font-semibold text-gray-700">Tables</label>
            <input type="number" name="tables" value="{{ room.tables }}" class="border border-gray-300 rounded px-3 py-2 text-sm">

            <label class="text-sm font-semibold text-gray-700">Chairs</label>
            <input type="number" name="chairs" value="{{ room.chairs }}" class="border border-gray-300 rounded px-3 py-2 text-sm">

            <label class="text-sm font-semibold text-gray-700">Upload Image</label>
            <input type="file" name="image" class="border border-gray-300 rounded px-3 py-2 text-sm">

            <button type="submit" class="mt-2 bg-emerald-600 text-white px-4 py-2 rounded hover:bg-emerald-700 font-semibold transition text-sm">
              Update Room
            </button>
          </form>
        </div>
        {% endfor %}
      </div>
    </section>

  </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    if (Notification.permission !== "granted") {
        Notification.requestPermission();
    }

    async function checkPasswordRequests() {
        const res = await fetch("{% url 'pending_password_requests_api' %}");
        if (res.ok) {
            const requests = await res.json();
            requests.forEach(r => {
                if (Notification.permission === "granted") {
                    new Notification("Password Change Request", {
                        body: `User: ${r.user}\nRequested At: ${r.requested_at}`,
                        icon: "/static/img/notification-icon.png"
                    });
                }
            });
        }
    }

    async function checkUserRegistrations() {
        const res = await fetch("{% url 'pending_user_registrations_api' %}");
        if (res.ok) {
            const users = await res.json();
            users.forEach(u => {
                if (Notification.permission === "granted") {
                    new Notification("New User Registration", {
                        body: `Username: ${u.username}\nDate Joined: ${u.date_joined}`,
                        icon: "/static/img/notification-icon.png"
                    });
                }
            });
        }
    }

    setInterval(checkPasswordRequests, 10000);
    setInterval(checkUserRegistrations, 10000);
});
</script>

{% endblock %}
